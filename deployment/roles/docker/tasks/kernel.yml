---
- name: kernel - add backports repo
  apt_repository: repo='deb http://ftp.debian.org/debian/ wheezy-backports main non-free contrib' update_cache=yes state=present

- name: kernel - install backported kernel
  apt: pkg="linux-image-amd64" default_release='wheezy-backports' state=latest

- name: kernel - add cgroup options to kernel boot arguments
  lineinfile: dest=/etc/default/grub line='GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1"' state=present
  register: grub

- name: kernel - update grub and reboot
  shell: shutdown -r now
  when: grub|changed
  register: reboot

- name: kernel - wait for reboot
  local_action: wait_for host={{ inventory_hostname }}
    state=started
    delay=30
    timeout=600
  sudo: no
  when: grub|changed
